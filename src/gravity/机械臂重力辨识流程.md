## 机械臂重力项参数辨识

本文利用`SympyBotics`工具分析机械臂各关节重力矩，并对各关节重力矩进行惯性参数分离，得到各关节参数分离式的重力矩表达式，最后采集数据并利用最小二乘法辨识连杆惯性参数。

### 软件安装
首先安装`sympybotics`软件包
```
git clone https://github.com/cdsousa/SymPyBotics.git
cd sympybotics
python setup.py install
```
该软件包仅依赖于`sympy`，但是由于发布时间很早，需要安装相适应版本的`sympy`
```
python3 -m pip uninstall sympy #or uninstall through OS package manager, etc.
python3 -m pip install sympy==0.7.5
```

### 公式推导
定义机械臂模型
```
import sympy
import numpy
import sympybotics

rbtdef = sympybotics.RobotDef('XRobot',
	[(      0,        0,     0.048,        'q'),# (alpha, a, d, theta)
         ('-pi/2',        0,         0,   'q-pi/2'),
         (      0,     0.51,         0,   'q+pi/2'),
         (      0,     0.51,      0.11,   'q-pi/2'),
         ('-pi/2',        0,   0.08662,        'q'),
         ( 'pi/2',        0,     0.035,        'q')],
         dh_convention='mdh')
         
rbtdef.frictionmodel = {'Coulomb', 'viscous'}
rbtdef.gravityacc = sympy.Matrix([0.0, 0.0, -9.81])
rbt = sympybotics.RobotDynCode(rbtdef, verbose=True)
```
生成关节力矩表达式，包含惯性力，科氏力，离心力，重力和摩擦力
```
rbt.calc_base_parms()
rbt.dyn.gen_all()
```
机械臂各关节的重力矩与机械臂具体模型有关，本文中的机械臂模型中关节1无重力矩，关节6重力矩很小，可忽略。因此重点计算关节2至关节5的重力矩表达式。  
1. 计算关节5的重力矩表达式
```
tau_grav5 = sympy.simplify(rbt.dyn.g[4])
print('\n\nthe gravity torque of joint5 is: ')
print(tau_grav5)
l_5x,l_5y,l_6x,l_6y,l_6z,m_6 = sympy.symbols('l_5x,l_5y,l_6x,l_6y,l_6z,m_6')
mono5 = [l_5x,l_5y,l_6x,l_6y,l_6z,m_6]
tau_grav5 = sympy.poly(tau_grav5,mono5)
for mono in mono5:
	print('\nthe coeff of ',mono,' is: ')
	print(tau_grav5.coeff_monomial(mono))
```
可求得关节5重力矩中各惯性参数的系数
```
the gravity torque of joint5 is: 
(-9.81*l_5x*sin(q5) - 9.81*l_5y*cos(q5) - 9.81*l_6x*sin(q5)*cos(q6) + 9.81*l_6y*sin(q5)*sin(q6) + 9.81*l_6z*cos(q5) + 0.34335*m_6*cos(q5))*cos(q2 + q3 + q4)

the coeff of  l_5x  is: 
-9.81*sin(q5)*cos(q2 + q3 + q4)

the coeff of  l_5y  is: 
-9.81*cos(q5)*cos(q2 + q3 + q4)

the coeff of  l_6x  is: 
-9.81*sin(q5)*cos(q6)*cos(q2 + q3 + q4)

the coeff of  l_6y  is: 
9.81*sin(q5)*sin(q6)*cos(q2 + q3 + q4)

the coeff of  l_6z  is: 
9.81*cos(q5)*cos(q2 + q3 + q4)

the coeff of  m_6  is: 
0.34335*cos(q5)*cos(q2 + q3 + q4)
```


2. 计算关节4的重力矩表达式
```
tau_grav4 = sympy.simplify(rbt.dyn.g[3])
print('\n\nthe gravity torque of joint4 is: ')
print(tau_grav4)
l_4x,l_4y,l_5z,m_5 = sympy.symbols('l_4x,l_4y,l_5z,m_5')
mono4 = [l_4x,l_4y,l_5x,l_5y,l_5z,m_5,l_6x,l_6y,l_6z,m_6]
tau_grav4 = sympy.poly(tau_grav4,mono4)
for mono in mono4:
	print('\nthe coeff of ',mono,' is: ')
	print(tau_grav4.coeff_monomial(mono))
```
可求得关节4重力矩中各惯性参数的系数
```
the gravity torque of joint4 is: 
-9.81*l_4x*sin(q2 + q3 + q4) - 9.81*l_4y*cos(q2 + q3 + q4) - 9.81*l_5x*sin(q2 + q3 + q4)*cos(q5) + 9.81*l_5y*sin(q5)*sin(q2 + q3 + q4) - 9.81*l_5z*cos(q2 + q3 + q4) - 9.81*l_6x*sin(q6)*cos(q2 + q3 + q4) - 9.81*l_6x*sin(q2 + q3 + q4)*cos(q5)*cos(q6) + 9.81*l_6y*sin(q6)*sin(q2 + q3 + q4)*cos(q5) - 9.81*l_6y*cos(q6)*cos(q2 + q3 + q4) - 9.81*l_6z*sin(q5)*sin(q2 + q3 + q4) - 0.849742200001078*m_5*cos(q2 + q3 + q4) - 0.34335*m_6*sin(q5)*sin(q2 + q3 + q4) - 0.849742200001078*m_6*cos(q2 + q3 + q4)

the coeff of  l_4x  is: 
-9.81*sin(q2 + q3 + q4)

the coeff of  l_4y  is: 
-9.81*cos(q2 + q3 + q4)

the coeff of  l_5x  is: 
-9.81*sin(q2 + q3 + q4)*cos(q5)

the coeff of  l_5y  is: 
9.81*sin(q5)*sin(q2 + q3 + q4)

the coeff of  l_5z  is: 
-9.81*cos(q2 + q3 + q4)

the coeff of  m_5  is: 
-0.849742200001078*cos(q2 + q3 + q4)

the coeff of  l_6x  is: 
-9.81*sin(q6)*cos(q2 + q3 + q4) - 9.81*sin(q2 + q3 + q4)*cos(q5)*cos(q6)

the coeff of  l_6y  is: 
9.81*sin(q6)*sin(q2 + q3 + q4)*cos(q5) - 9.81*cos(q6)*cos(q2 + q3 + q4)

the coeff of  l_6z  is: 
-9.81*sin(q5)*sin(q2 + q3 + q4)

the coeff of  m_6  is: 
-0.34335*sin(q5)*sin(q2 + q3 + q4) - 0.849742200001078*cos(q2 + q3 + q4)
```


3. 计算关节3的重力矩表达式
```
tau_grav3 = sympy.simplify(rbt.dyn.g[2])
print('\n\nthe gravity torque of joint3 is: ')
print(tau_grav3)
l_3x,l_3y,m_4 = sympy.symbols('l_3x,l_3y,m_4')
mono3 = [l_3x,l_3y,l_4x,l_4y,m_4,l_5x,l_5y,l_5z,m_5,l_6x,l_6y,l_6z,m_6]
tau_grav3 = sympy.poly(tau_grav3,mono3)
for mono in mono3:
	print('\nthe coeff of ',mono,' is: ')
	print(tau_grav3.coeff_monomial(mono))
```
可求得关节3重力矩中各惯性参数的系数
```
the gravity torque of joint3 is: 
-9.81*l_3x*cos(q2 + q3) + 9.81*l_3y*sin(q2 + q3) - 9.81*l_4x*sin(q2 + q3 + q4) - 9.81*l_4y*cos(q2 + q3 + q4) - 9.81*l_5x*sin(q2 + q3 + q4)*cos(q5) + 9.81*l_5y*sin(q5)*sin(q2 + q3 + q4) - 9.81*l_5z*cos(q2 + q3 + q4) - 9.81*l_6x*sin(q6)*cos(q2 + q3 + q4) - 9.81*l_6x*sin(q2 + q3 + q4)*cos(q5)*cos(q6) + 9.81*l_6y*sin(q6)*sin(q2 + q3 + q4)*cos(q5) - 9.81*l_6y*cos(q6)*cos(q2 + q3 + q4) - 9.81*l_6z*sin(q5)*sin(q2 + q3 + q4) - 5.0031*m_4*cos(q2 + q3) - 5.0031*m_5*cos(q2 + q3) - 0.849742200001078*m_5*cos(q2 + q3 + q4) - 0.34335*m_6*sin(q5)*sin(q2 + q3 + q4) - 5.0031*m_6*cos(q2 + q3) - 0.849742200001078*m_6*cos(q2 + q3 + q4)

the coeff of  l_3x  is: 
-9.81*cos(q2 + q3)

the coeff of  l_3y  is: 
9.81*sin(q2 + q3)

the coeff of  l_4x  is: 
-9.81*sin(q2 + q3 + q4)

the coeff of  l_4y  is: 
-9.81*cos(q2 + q3 + q4)

the coeff of  m_4  is: 
-5.0031*cos(q2 + q3)

the coeff of  l_5x  is: 
-9.81*sin(q2 + q3 + q4)*cos(q5)

the coeff of  l_5y  is: 
9.81*sin(q5)*sin(q2 + q3 + q4)

the coeff of  l_5z  is: 
-9.81*cos(q2 + q3 + q4)

the coeff of  m_5  is: 
-5.0031*cos(q2 + q3) - 0.849742200001078*cos(q2 + q3 + q4)

the coeff of  l_6x  is: 
-9.81*sin(q6)*cos(q2 + q3 + q4) - 9.81*sin(q2 + q3 + q4)*cos(q5)*cos(q6)

the coeff of  l_6y  is: 
9.81*sin(q6)*sin(q2 + q3 + q4)*cos(q5) - 9.81*cos(q6)*cos(q2 + q3 + q4)

the coeff of  l_6z  is: 
-9.81*sin(q5)*sin(q2 + q3 + q4)

the coeff of  m_6  is: 
-0.34335*sin(q5)*sin(q2 + q3 + q4) - 5.0031*cos(q2 + q3) - 0.849742200001078*cos(q2 + q3 + q4)

```


4. 计算关节2的重力矩表达式
```
tau_grav2 = sympy.simplify(rbt.dyn.g[1])
print('\n\nthe gravity torque of joint2 is: ')
print(tau_grav2)
l_2x,l_2y,m_3 = sympy.symbols('l_2x,l_2y,m_3')
mono2 = [l_2x,l_2y,l_3x,l_3y,m_3,l_4x,l_4y,m_4,l_5x,l_5y,l_5z,m_5,l_6x,l_6y,l_6z,m_6]
tau_grav2 = sympy.poly(tau_grav2,mono2)
for mono in mono2:
	print('\nthe coeff of ',mono,' is: ')
	print(tau_grav2.coeff_monomial(mono))
```
可求得关节2重力矩中各惯性参数的系数
```
the gravity torque of joint2 is: 
-9.81*l_2x*sin(q2) - 9.81*l_2y*cos(q2) - 9.81*l_3x*cos(q2 + q3) + 9.81*l_3y*sin(q2 + q3) - 9.81*l_4x*sin(q2 + q3 + q4) - 9.81*l_4y*cos(q2 + q3 + q4) - 0.8497422*(m_5 + m_6)*sin(q5)**2*cos(q2 + q3 + q4) - 0.8497422*(m_5 + m_6)*cos(q5)**2*cos(q2 + q3 + q4) - 5.0031*(m_4 + m_5 + m_6)*sin(q4)*sin(q2 + q3 + q4) - 5.0031*(m_4 + m_5 + m_6)*cos(q4)*cos(q2 + q3 + q4) + 5.0031*(m_3 + m_4 + m_5 + m_6)*sin(q3)*cos(q2 + q3) - 0.050031*(m_3 + m_4 + m_5 + m_6)*sin(q2 + q3)*cos(q3) - (9.81*l_5x*sin(q2 + q3 + q4) + 9.81*l_5z*cos(q5)*cos(q2 + q3 + q4) + 9.81*l_6x*(sin(q6)*cos(q5)*cos(q2 + q3 + q4) + sin(q2 + q3 + q4)*cos(q6)) - l_6y*(9.81*sin(q6)*sin(q2 + q3 + q4) - 9.81*cos(q5)*cos(q6)*cos(q2 + q3 + q4)))*cos(q5) - (-9.81*l_5y*sin(q2 + q3 + q4) + 9.81*l_5z*sin(q5)*cos(q2 + q3 + q4) + 9.81*l_6x*sin(q5)*sin(q6)*cos(q2 + q3 + q4) + 9.81*l_6y*sin(q5)*cos(q6)*cos(q2 + q3 + q4) + 9.81*l_6z*sin(q2 + q3 + q4) + 0.34335*m_6*sin(q2 + q3 + q4))*sin(q5)

the coeff of  l_2x  is: 
-9.81*sin(q2)

the coeff of  l_2y  is: 
-9.81*cos(q2)

the coeff of  l_3x  is: 
-9.81*cos(q2 + q3)

the coeff of  l_3y  is: 
9.81*sin(q2 + q3)

the coeff of  m_3  is: 
5.0031*sin(q3)*cos(q2 + q3) - 0.050031*sin(q2 + q3)*cos(q3)

the coeff of  l_4x  is: 
-9.81*sin(q2 + q3 + q4)

the coeff of  l_4y  is: 
-9.81*cos(q2 + q3 + q4)

the coeff of  m_4  is: 
5.0031*sin(q3)*cos(q2 + q3) - 5.0031*sin(q4)*sin(q2 + q3 + q4) - 0.050031*sin(q2 + q3)*cos(q3) - 5.0031*cos(q4)*cos(q2 + q3 + q4)

the coeff of  l_5x  is: 
-9.81*sin(q2 + q3 + q4)*cos(q5)

the coeff of  l_5y  is: 
9.81*sin(q5)*sin(q2 + q3 + q4)

the coeff of  l_5z  is: 
-9.81*sin(q5)**2*cos(q2 + q3 + q4) - 9.81*cos(q5)**2*cos(q2 + q3 + q4)

the coeff of  m_5  is: 
5.0031*sin(q3)*cos(q2 + q3) - 5.0031*sin(q4)*sin(q2 + q3 + q4) - 0.849742200001078*sin(q5)**2*cos(q2 + q3 + q4) - 0.050031*sin(q2 + q3)*cos(q3) - 5.0031*cos(q4)*cos(q2 + q3 + q4) - 0.849742200001078*cos(q5)**2*cos(q2 + q3 + q4)

the coeff of  l_6x  is: 
-9.81*sin(q5)**2*sin(q6)*cos(q2 + q3 + q4) - 9.81*sin(q6)*cos(q5)**2*cos(q2 + q3 + q4) - 9.81*sin(q2 + q3 + q4)*cos(q5)*cos(q6)

the coeff of  l_6y  is: 
-9.81*sin(q5)**2*cos(q6)*cos(q2 + q3 + q4) + 9.81*sin(q6)*sin(q2 + q3 + q4)*cos(q5) - 9.81*cos(q5)**2*cos(q6)*cos(q2 + q3 + q4)

the coeff of  l_6z  is: 
-9.81*sin(q5)*sin(q2 + q3 + q4)

the coeff of  m_6  is: 
5.0031*sin(q3)*cos(q2 + q3) - 5.0031*sin(q4)*sin(q2 + q3 + q4) - 0.849742200001078*sin(q5)**2*cos(q2 + q3 + q4) - 0.34335*sin(q5)*sin(q2 + q3 + q4) - 0.050031*sin(q2 + q3)*cos(q3) - 5.0031*cos(q4)*cos(q2 + q3 + q4) - 0.849742200001078*cos(q5)**2*cos(q2 + q3 + q4)

```


### 测试方案设计
重力矩测试的总体思路就是以非常慢的速度匀速旋转所测试的关节，往复慢速运动一次，两次力矩之和即为重力矩的两倍，便可消除摩擦力矩以及其他力矩的耦合作用。  

考虑到所需要的辨识的机械臂模型，本文设定的起始和终止构型如下：
```
q0 = [-60, -160, -90, -90, 45]degrees
qf = [60, 20, 90, 90, -45]degrees
```
机械臂慢速在两构型之间往复运动一次。

### 测试结果分析
机械臂各关节实际力矩与重力矩变化曲线如下图所示

![机械臂各关节重力矩](https://wx4.sinaimg.cn/large/97a39926gy1gw7pir8hlqj21js0u0jxz.jpg)

重力矩参数辨识结果对比如下图所示

![重力辨识结果对比](https://wx3.sinaimg.cn/large/97a39926gy1gw7piwde07j21js0u043a.jpg)


